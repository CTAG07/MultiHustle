name: Create and publish release

on:
  push:
    branches: [ main ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        token: ${{ secrets.GIT_TOKEN }}
    - name: Zip folder
      id: zip_folder
      run: zip -r MultiHustle.zip MultiHustle/
    - name: Get latest release version
      id: get_latest_version
      uses: actions/github-script@v6
      with:
        script: |
          const LATEST_VERSION = await github.rest.repos.getLatestRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          console.log(`LATEST_VERSION=${LATEST_VERSION.data.tag_name}`);
    - name: Increment release version
      id: increment_version
      run: |
        VERSION_NUMBER=$(echo "${{ steps.get_latest_version.outputs.LATEST_VERSION }}" | sed 's/^v//')
        NEW_VERSION_NUMBER=$((VERSION_NUMBER + 1))
        echo "NEW_VERSION_NUMBER=v${NEW_VERSION_NUMBER}"
    - name: Create release
      id: create_release
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GIT_TOKEN }}
        tag: v${{ steps.increment_version.outputs.NEW_VERSION_NUMBER }}
        artifacts: ./MultiHustle.zip
        makeLatest: true
